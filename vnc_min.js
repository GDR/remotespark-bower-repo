var svManager={getInstance:function(){var g=window.$vnc;return g&&g.running&&g.running()?g:null}};function connvertServer(g){var q={};q.id=g.id;q.server=g.id;q.displayName=g.displayName||g.id;if(g=g.vnc){for(var H in g)q[H]=g[H];q.pwd=g.password||""}return q}
svGlobal.Vnc=function(g,q,H,X){function qa(a,c){var d=[],b=null,e=new hi5.graphic.Rectangle(0,0,0,0),f="Uint8ClampedArray"in window;this.width=a;this.height=c;var l=!1,g=this;this.pause=function(a){l=a};this.release=function(){d=b=g=null};this.isPaused=function(){return l};this.setContext=function(a){a!=b&&(b||!a||a.createImageData(1,1).data.buffer||(f=!1),b=a)};this.getContext=function(){return b};this.resize=function(b,e){for(var k=0;k<e;k++)d[k]=new Uint32Array(b);g.width=a=b;g.height=c=e};g.resize(a,
c);this.getBuffer=function(){return d};this.setRGB=function(a,b,c){d[b][a]=c|4278190080};this.getRGB=function(a,b){return d[b][a]};this.setRGBs=function(a,b,c,e,f,t,y){var l=0,g=0,h=a+c;e=b+e;if(f.subarray)for(;b<e;b++,t+=y)d[b].set(f.subarray(t,t+c),a);else for(;b<e;b++,t+=y)for(g=t,c=d[b],l=a;l<h;l++)c[l]=f[g++]};this.moveArea=function(a,b,c,e,f,y){if(0<y)for(f=a+f,y=b+y,--e;0<=e;e--)d[y+e].set(d[b+e].subarray(a,a+c),f);else if(0>y){f=a+f;y=b+y;for(var l=0;l<e;l++)d[y+l].set(d[b+l].subarray(a,a+
c),f)}else if(0<f){f=a+f;y=b+y;var l=d,g,n,h;for(--c;0<=c;c--)for(n=f+c,h=a+c,g=0;g<e;g++)l[y+g][n]=l[b+g][h]}else{f=a+f;y=b+y;var l=d,u;for(g=0;g<c;g++)for(h=f+g,u=a+g,n=0;n<e;n++)l[y+n][h]=l[b+n][u]}};this.getRGBs=function(a,b,c,e){var f=_Uint32Array(c*e);f[0]=0;var y=d;c=a+c;e=b+e;for(var l=0,g=b;g<e;g++)for(b=a;b<c;b++)f[l++]=y[g][b];return f};this.repaint=function(e,l,k,m){if(b){0>e&&(k+=e,e=0);0>l&&(m+=l,l=0);e+k>a&&(k=a-e);l+m>c&&(m=c-l);var J=b.createImageData(k,m),t=J.data,g=e+k;m=l+m;var n=
0,x=d;if(f)for(var t=new Uint32Array(t.buffer),h=l;h<m;h++)t.set(x[h].subarray(e,g),n),n+=k;else for(var u,p,h=l;h<m;h++)for(k=e;k<g;k++)u=x[h][k],p=n<<2,t[p]=u&255,t[p+1]=u>>8&255,t[p+2]=u>>16&255,t[p+3]=255,n++;b.putImageData(J,e,l)}};this.postPaint=function(a,b,c,d){0<e.width?e.union(a,b,c,d):(e.x=a,e.y=b,e.width=c,e.height=d)};this.commitPaint=function(){0<e.width&&(this.repaint(e.x,e.y,e.width,e.height),e.width=0)};this.fillRect=function(a,b,c,e,f){c=a+c;e=b+e;for(var y=b;y<e;y++)if(d[y].fill)d[y].fill(f,
a,c);else{var l=d[y];for(b=a;b<c;b++)l[b]=f}}}function ea(){var a=g.indexOf("://"),c=g.substring(a+3),a=c.indexOf("/");0<a&&(c=c.substring(0,a));return location.protocol+"//"+c}function sa(a){if(!sessionId)return"";a=hi5.browser.httpGet(ea()+"/CLIP?s="+sessionId+"&t="+Date.now(),!1);setTimeout(function(){n.send("883")},999);return a}function ta(){this.ws=null;this.capsLock=this.numLock=!1;this.setJoinMode=f.setJoinMode;this.requestControl=f.requestControl;this.writeKeyComb=f.writeKeyComb;this.getAppMode=
function(){return f.mode};this.send=function(a){z&&this.ws.send(a)};this.sendInput=function(a){f.writeRawInput(a);if(f.onactivity)f.onactivity(a)};this.getAppInfo=function(){return f.sessionInfo.appInfo};this.onresize=function(a){};this.onorientationchange=function(a){};this.getClipData=sa;this.onfocus=function(a){};this.fileCallback=[];this.getShareFiles=function(a,c){loggedin&&(this.ws.send("3A5"+a),this.fileCallback.push(c))};this.notifyFiles=function(a){for(var c=this.fileCallback,d=0,b=c.length;d<
b;d++)c[d](a)};this.getFile=function(a){window.open(f.getFileUrl(a))};this.removeFile=function(a){uploadMgr&&uploadMgr.fileService.remove(a)};this.getFileLink=function(a){return ea()+"/DOWNLOAD?s="+sessionId+"&f="+a};this.getGateway=function(){return g};this.reconnect=function(a,c,d){}}function W(a){return"on"==a||"true"==a}function Q(a,c,d){this.need=a;this.handler=c;this.repeat=d||1}function fa(a){var c=0,d=0,b=new Uint8Array(a),e=this,f=new Q(0,null,0);this.release=function(){e=b=f=null};this.getHandler=
function(){return f};this.getData=function(){return b};this.getPosition=function(){return c};this.setPosition=function(a){c=a};this.getEnd=function(){return d};this.set=function(a,e,f){b=a;c=e;d=f};this.handle=function(){f.handler(e,f)};this.setHandler=function(a){a&&1>a.need&&svGlobal.logger.warn("need < 1");(f=a)&&d-c>=a.need&&a.handler(e,a)};this.getByte=function(){return b[c++]};this.peekByte=function(){return b[c]};this.getBE32=function(){return b[c++]<<24|b[c++]<<16|b[c++]<<8|b[c++]};this.getBE16=
function(){return b[c++]<<8|b[c++]};this.skip=function(a){c+=a};this.skipBack=function(a){c-=a};this.getBytes=function(a,e){if(e)for(var d=0;d<a;d++)e[d]=b[c++];else return d=c,c+=a,b.subarray(d,c)};this.copyToByteArray=function(a,c,e,d){hi5.Arrays.arraycopy(b,e,a,c,d)};this.getString16LE=function(a,c){for(var e="",d=a;d<c;)var f=b[d++]|b[d++]<<8,e=e+String.fromCharCode(f);return e}}function ua(){if(!z){if(Y)n=Y,U(p.width,p.height);else{var a=hi5.tool.replaceQuery(g,"pwd","x"),c=hi5.browser.binaryWS();
c&&(a+="&binary=on");var d=window.opener;if(d){c=null;try{c=d.__sparkUser}catch(b){}c&&(d=c.account,c=c.session,d&&(a+="&account="+d),c&&(a+="&session="+c))}c=hi5.browser.isChrome&&hi5.browser.isDesktop;n=new WebSocket(a+("&pasteCap="+(c?3:0)),"vnc");n.binaryType="arraybuffer"}Z.ws=n;svGlobal.logger.info(g);n.onopen=va;n.onmessage=function(a){a=a.data;if("string"!=typeof a){var c=new Uint8Array(a);null!=K&&K.add(new RecordingObj(c,0,a.byteLength));B.set(c,0,a.byteLength);B.handle()}else{var c=parseInt(a.substring(0,
2),16),d=a.substring(2);switch(c){case 26:c=d;a=JSON.parse(c);if(a.name){svGlobal.logger.info("msg="+c);if(f.onerror)f.onerror(a);c=__svi18n.errorCode["S"+a.name]||"";c+=a.message;f.showMessage(c)}else 0<svGlobal.log&&console.erro("No error code for message:"+c);break;case 27:0!=hi5.appcfg.drawLicense&&v.drawLicense(d);break;case 56:c=a=JSON.parse(d);sessionId=a.session;c.server=f.server;if(d=hi5.$("joinSelect"))d.value=c.joinMode;if(d=hi5.$("requestControl"))d.disabled=c.hasControl;var d=hi5.appcfg.page&&
hi5.appcfg.page.joinvnc||"joinvnc.html",d=location.protocol+"//"+location.host+"/"+d+"?id="+a.numericId,l=a.webAddress;if(l&&0<l.length){var g=l.indexOf("://"),l=l.substring(g+3),g=l.indexOf("/");0<g&&(l=l.substring(0,g));l.toLowerCase()!=location.host.toLowerCase()&&(d+="&gateway="+l)}c.joinLink=d;f.sessionInfo.appInfo=c;a.ver&&a.ver!=svGlobal.version&&svGlobal.logger.info("Client:"+svGlobal.version+" server:"+a.ver);if(f.onsessionstart)f.onsessionstart(f.sessionInfo);break;case 59:a=hi5.Base64.dec(d,
0);a=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;a&256||v.disableShadow();break;case 61:a=JSON.parse(d);switch(a.type){case 0:U(a.width,a.height);L=a.color/8|0;if(c=a.server)f.server=a.server,f.setTitle&&(document.title=p.displayName||f.server);playLength=a.length;v&&v.setAutoScale(!0);if(f.onopened)f.onopened(a);break;case 1:a=a.duration;if(f.onprogress)f.onprogress(a,playLength);break;case 2:2==a.status?(ga(),z=!0):(c=0==a.status,w.pause(c),c||w.repaint(0,0,w.width,w.height),a.warn&&f.showMessage(c?__svi18n.info.sessionPaused:
__svi18n.info.sessionResumed))}break;case 62:ha(d);break;default:svGlobal.logger.warn("@TODO:"+a+"\n")}}};n.onclose=V;n.onerror=wa}}function va(a){svGlobal.logger.info("opened...");z=!0;n.send("87"+navigator.userAgent);if(f.onopen)f.onopen()}function wa(a){svGlobal.logger.warn(a)}function V(a){svGlobal.logger.warn("closed ...");B&&B.getHandler()&&B.getHandler().handler==ia&&f.onautherror&&f.onautherror();R=z=!1;if(f&&f.onclose)f.onclose();try{null!=K&&(K.exit(),K=null),v&&v.close()}catch(c){}r=M=
null;B&&(B.release(),B=null);I=null;n&&(n.onopen=null,n.onmessage=null,n.onclose=null,n=n.onerror=null);N&&(N.release(),N=null);S&&(S.release(),S=null);v=Z=aa=null;w&&(w.release(),w=null);f&&(f=null);window&&window.$vnc&&(window.$vnc=null);null!=K&&(K.exit(),K=null)}function ja(){var a=new Uint8Array(1);a[0]=W(p.share)?1:0;n.send(a.buffer);B.setHandler(new Q(24,function(a){if(f.onloggedin)f.onloggedin();var d=f.sessionInfo;d.width=O=a.getBE16();d.height=P=a.getBE16();d.bpp=a.getByte();d.depth=a.getByte();
d.bigEndian=0!=a.getByte();d.trueColor=0!=a.getByte();a.skip(12);for(var b=a.getBE32(),e="",y=0;y<b;y++)e+=String.fromCharCode(a.getByte());d.name=e;svGlobal.logger.info("server name:"+e);f.setTitle&&(document.title=e);U(O,P);a=[16,7,1,0,4294967056,4294967057,4294967064,4294967073,4294967040,4294967264];d=p.encoding;8==p.color&&"Tight"==d&&(d="ZRLE");switch(d){case "Tight":a[0]=7;a[1]=16;break;case "Raw":a[0]=0,a[3]=16}a[8]+=parseInt(p.compression||6);a[9]+=parseInt(p.quality||5);d=a.length;b=new Uint8Array(4+
4*d);b[0]=2;b[2]=d>>8&255;b[3]=d&255;for(e=0;e<d;e++)b[4+4*e]=a[e]>>24&255,b[5+4*e]=a[e]>>16&255,b[6+4*e]=a[e]>>8&255,b[7+4*e]=a[e]&255;n.send(b.buffer);a=parseInt(p.color);switch(a){case 32:ka(32,24,!1,!0,255,255,255,0,8,16);break;case 8:ka(8,8,!1,!0,7,7,3,0,3,6);break;default:svGlobal.logger.warn("invliad color depath:"+a)}L=a/8|0;ba(0,0,O,P,!1);B.setHandler(aa);R=!0;void 0!=p.recording&&"on"==p.recording&&(a=p,K=new RecordingManager,d=a.server,a={name:d,width:a.width,height:a.height,color:a.server_bpp,
namesuffix:".vncv",filetag:"VNCV",duration:0},K.setHeader(a))}))}function ia(a){a=a.getBE32();svGlobal.logger.info("sec rst: "+a);var c={code:a,message:""};switch(a){case 0:ja();return;case 1:c.message=__svi18n.vnc.authError;break;case 2:c.message="Too many failed authentication";break;default:c.message="Unknown auth error"+a}B.setHandler(null);f.onautherror&&f.onautherror(c)||(f.showMessage(c.message),f.close())}function ka(a,c,d,b,e,f,l,g,p,ra){var k=new Uint8Array(20);k[0]=0;k[4]=a;k[5]=c;k[6]=
d?1:0;k[7]=b?1:0;k[8]=e>>8&255;k[9]=e&255;k[10]=f>>8&255;k[11]=f&255;k[12]=l>>8&255;k[13]=l&255;k[14]=g;k[15]=p;k[16]=ra;n.send(k.buffer)}function ba(a,c,d,b,e){var f=new Uint8Array(10);f[0]=3;f[1]=e?1:0;f[2]=a>>8&255;f[3]=a&255;f[4]=c>>8&255;f[5]=c&255;f[6]=d>>8&255;f[7]=d&255;f[8]=b>>8&255;f[9]=b&255;n.send(f.buffer)}function la(){var a=new TINF;a.init(2==f.mode?120:0);var c=new fa(0),d=new Uint32Array(4096),b=new Uint32Array(128);this.release=function(){b=d=null;a.release();a=null;c.release();
c=null};this.getHistory=function(){return a.getHistory()};this.setHistory=function(c){a.setHistory(c)};this.decode=function(e,f,l,g,n){var p=e.getBE32();e=e.getBytes(p);e=a.uncompress(e,0);var k=0,m=0;c.set(e.dest,0,e.destIndex);e=l;var p=f,J=0,t=0,k=0,m=!1,F=0,A=b,x=k=m=0,h=c.getByte,u=d;for(e=l;e<l+n;e+=64)for(J=Math.min(l+n-e,64),p=f;p<f+g;p+=64){t=Math.min(f+g-p,64);k=h();m=0!=(k&128);F=k&127;if(1==L)for(k=0;k<F;k++)A[k]=T[h()];else for(k=0;k<F;k++)A[k]=h()|h()<<8|h()<<16|4278190080;if(1==F)w.fillRect(p,
e,t,J,A[0]);else{if(m)if(0==F)for(m=0,k=m+t*J;m<k;){var x=1==L?T[h()]:h()|h()<<8|h()<<16|4278190080,G=1;do F=h(),G+=F;while(255==F);if(u.fill)u.fill(x,m,m+G),m+=G;else for(;0<G--;)u[m++]=x}else for(m=0,k=m+t*J;m<k;){x=h();G=1;if(0!=(x&128)){do F=h(),G+=F;while(255==F)}x&=127;x=A[x];if(u.fill)u.fill(x,m,m+G),m+=G;else for(;0<G--;)u[m++]=x}else if(m=t*J,0==F)if(1==L)for(k=0;k<m;k++)u[k]=T[h()];else for(k=0;k<m;k++)u[k]=h()|h()<<8|h()<<16|4278190080;else for(G=16<F?8:4<F?4:2<F?2:1,k=m=0;k<J;k++)for(var x=
m+t,q=F=0;m<x;)0==q&&(F=h(),q=8),q-=G,u[m++]=A[F>>q&(1<<G)-1&127];w.setRGBs(p,e,t,J,u,0,t)}}w.postPaint(f,l,g,n)}}function ma(){function a(a,c,b,d,e){this.draw=function(){I.fillStyle=e;I.fillRect(a,c,b,d)};this.type=0;this.ready=function(){return!0}}function c(a,c,b){this.draw=function(){I.putImageData(b,a,c)};this.type=1;this.ready=function(){return!0}}function d(a,c,b){this.draw=function(){I.drawImage(b,a,c)};this.type=2;this.ready=function(){return!!b.src&&b.complete};this.image=b}function b(){function a(){for(;0<
c.length;){var b=c[0];if(!b.ready())break;b.draw();c.shift()}}var c=[];this.push=function(b){c.push(b);2==b.type?b.image.onload=a:a()}}function e(){var a=n[l];a||(a=new TINF,a.init(2==f.mode?120:0),n[l]=a);return a}function g(a){var c=a.getByte(),b=c&127;c&128&&(c=a.getByte(),b|=(c&127)<<7,c&128&&(b|=a.getByte()<<14));return b}var l=0,n={},p={data:[0],length:0},q=Array(256);q[0]=0;this.inUse=!1;var k=this,m=new b;this.release=function(){n=p=q=k=m=null};this.drawImageData=function(a,b,d){m.push(new c(b,
d,a))};this.decode=function(b,f,n,A,x){k.inUse=!0;var h=b.getByte();switch(h>>4){case 8:m.push(new a(f,n,A,x,"rgb("+b.getByte()+","+b.getByte()+","+b.getByte()+")"));break;case 9:h=g(b);A=hi5.Base64.enc(b.getData(),h,b.getPosition());b.skip(h);x=new Image;m.push(new d(f,n,x));x.src="data:image/jpeg;base64,"+A;break;default:if(l=(h&48)>>4,h=h&64?b.getByte():0,1==h){for(var u=b.getByte,w=u()+1,r=2!=w?A*x:x*((A+7)/8|0),D=0,v=0,C=h=0;D<w;D++)q[D]=u()|u()<<8|u()<<16|4278190080;h=b;C=r;12>C?(p.data=h.getBytes(C),
p.length=C):(C=g(h),h=e().uncompress(h.getBytes(C),0),p.data=h.dest,p.length=h.destIndex);b=p.data;u=I.createImageData(A,x);if("Uint8ClampedArray"in window){var E=new Uint32Array(u.data.buffer);if(2!=w)for(D=0;D<r;D++)E[D]=q[b[D]];else for(h=0,w=(A+7)/8|0,D=v=r=0;D<x;D++){for(var r=D*w,z=0;z<(A/8|0);z++)for(v=b[r+z],C=7;0<=C;C--)E[h++]=q[v>>C&1];v=8-A%8;for(C=7;C>=v;C--)E[h++]=q[b[r+z]>>C&1]}}else if(E=u.data,h=0,2!=w)for(D=0;D<r;D++)v=q[b[D]],E[h++]=v&255,E[h++]=v>>8&255,E[h++]=v>>16&255,E[h++]=
255;else for(var h=0,w=(A+7)/8|0,B=0,D=0;D<x;D++){r=D*w;for(z=0;z<(A/8|0);z++)for(v=b[r+z],C=7;0<=C;C--)B=q[v>>C&1],E[h++]=B&255,E[h++]=B>>8&255,E[h++]=B>>16&255,E[h++]=255;v=8-A%8;for(C=7;C>=v;C--)B=q[b[r+z]>>C&1],E[h++]=B&255,E[h++]=B>>8&255,E[h++]=B>>16&255,E[h++]=255}m.push(new c(f,n,u))}else if(0==h){h=A*x*3;11<h&&(h=g(b));C=A*x;u=3*C;b=11<u?e().uncompress(b.getBytes(h),0).dest:b.getBytes(u);u=I.createImageData(A,x);E=u.data;for(D=A=h=0;D<C;D++)E[h++]=b[A++],E[h++]=b[A++],E[h++]=b[A++],E[h++]=
255;m.push(new c(f,n,u))}else svGlobal.logger.info("xx filter:"+h)}}}function ha(a){var c=parseInt(a.substring(0,1),16),d,b;d=a.substring(1);var e=!1,g=f.sessionInfo.appInfo;switch(c){case 0:b=JSON.parse(d);ga();z=!0;e=b.width;d=b.height;if(e==O&&d==P)break;U(e,d);break;case 1:_reconnectOnResize=f.reconnectOnResize;f.reconnectOnResize=!1;b=JSON.parse(d);f.onsessionjoin&&(e=f.onsessionjoin(b));if(e)break;f.showMessage(__svi18n.info.joinsession.applyArgs([b.numericId,b.__ip,b.name]));break;case 2:b=
JSON.parse(d);0==b.joined&&(f.reconnectOnResize=_reconnectOnResize);f.onsessionexit&&(e=f.onsessionexit(b));if(e)break;f.showMessage(__svi18n.info.exitsession.applyArgs([b.numericId,b.__ip,b.name]));break;case 3:b=JSON.parse(d);g.joinMode!=b.mode&&(g.joinMode=b.mode,d=hi5.$("joinSelect"))&&(d.value=b.mode);if(g.hasControl)break;v.setReadOnly(!1);if(d=hi5.$("requestControl"))d.disabled=!0;f.ongivecontrol&&(e=f.ongivecontrol());if(e)break;f.showMessage(__svi18n.info.givecontrol);break;case 4:v.setReadOnly(!0);
g.hasControl=!1;if(d=hi5.$("requestControl"))d.disabled=!1;f.ontakebackcontrol&&(e=f.ontakebackcontrol());if(e)break;f.showMessage(__svi18n.info.nocontrol);break;case 5:g=function(){f.refuseControl(b.numericId);this.destroy()};a=function(){f.giveControl(b.numericId);this.destroy()};b=JSON.parse(d);f.onrequirecontrol&&(e=f.onrequirecontrol(b));if(e)break;e=__svi18n.info.title.applyArgs([b.name,b.numericId,b.__ip]);hi5.notifications.notify({title:e,msg:__svi18n.info.recontrol,cbYes:a,cbNo:g});break;
case 10:if(1==a.length)n.send("8E8"+hi5.Base64.enc(S.getHistory()));else if(S.setHistory(hi5.Base64.dec(a.substring(1),0)),f.refresh(),R=!0,f.onloggedin)f.onloggedin();break;case 11:g=function(){f.allowJoin(b.numericId,!1);this.destroy()};a=function(){f.allowJoin(b.numericId,!0);this.destroy()};b=JSON.parse(d);f.onrequirejoin&&(e=f.onrequirejoin(b));if(e)break;e=__svi18n.info.title.applyArgs([b.name,b.numericId,b.__ip]);hi5.notifications.notify({title:e,msg:__svi18n.info.reqjoin,cbYes:a,cbNo:g})}}
function xa(a){if(!f.openLink)return!1;var c=a;a=a.toLowerCase();var d=0==a.indexOf("http://")||0==a.indexOf("https://")||0==a.indexOf("ftp://")||0==a.indexOf("mailto:")||0==a.indexOf("tel:")||0==a.indexOf("callto:");d||(0==a.indexOf("www.")?(d=!0,a="http://"+a):0==a.indexOf("ftp.")&&(d=!0,a="ftp://"+a));if(d){if(0<a.indexOf("\r")||0<a.indexOf("\n"))return!1;if(f.onurlredirection&&f.onurlredirection(d))return!0;v.processLink(c);return!0}return!1}function ya(a){var c=0,d=0,b=0,e=0,g=0,l="",l=a.getByte();
switch(l){case 0:a.skip(1);for(var l=a.getBE16(),n=0;n<l;n++)switch(c=a.getBE16(),d=a.getBE16(),b=a.getBE16(),e=a.getBE16(),g=a.getBE32()>>>0,g){case 4294967073:U(b,e);break;case 240:case 4294967056:0!=b*e&&a.skip(((b+7)/8|0)*e*2+6);break;case 4294967057:0!=b*e&&a.skip(b*e*L+((b+7)/8|0)*e);break;case 4294967064:break;case 0:if(0<b*e){var g=a,p=b,q=e,k=null,e=p*q,b=0,m=g.getPosition(),r=g.getData(),t=void 0;if(N.inUse){p=I.createImageData(p,q);if(4==L){if("Uint8ClampedArray"in window)for(t=new Uint32Array(p.data.buffer),
b=0;b<e;b++)t[b]=r[m++]<<16|r[m++]<<8|r[m++]|4278190080,m++;else for(t=p.data,q=4*e;b<q;)t[b++]=r[m+2],t[b++]=r[m+1],t[b++]=r[m],t[b++]=255,m+=4;g.skip(4*e)}else if(1==L){if("Uint8ClampedArray"in window)for(t=new Uint32Array(p.data.buffer),b=0;b<e;b++)t[b]=T[r[m++]];else for(t=p.data,q=4*e,k=0;b<q;)k=T[r[m++]],t[b++]=k&255,t[b++]=k>>8&255,t[b++]=k>>16&255,t[b++]=255;g.skip(e)}N.drawImageData(p,c,d)}else{switch(L){case 4:if(0==m%4){m+=3;for(b=0;b<e;b++)r[m]=255,m+=4;k=new Uint32Array(g.getData().buffer,
g.getPosition(),e)}else for(k=new Uint32Array(e),b=0;b<e;b++)k[b]=r[m++]|r[m++]<<8|r[m++]<<16|4278190080,m++;g.skip(4*e);break;case 1:k=new Uint32Array(e);for(b=0;b<e;b++)k[b]=T[r[m++]];g.skip(e)}w.setRGBs(c,d,p,q,k,0,p);w.postPaint(c,d,p,q)}}break;case 1:g=a.getBE16();m=a.getBE16();N.inUse?I.putImageData(I.getImageData(g,m,b,e),c,d):(w.moveArea(g,m,b,e,c-g,d-m),w.repaint(c,d,b,e));break;case 7:N.decode(a,c,d,b,e);break;case 16:S.decode(a,c,d,b,e);break;default:svGlobal.logger.warn("Encoding "+g+
" is not supported"),f.close()}w.commitPaint();ba(0,0,O,P,!0);break;case 1:svGlobal.logger.warn("xxx color map");break;case 2:break;case 3:a.skip(3);l=a.getBE32();if(0<l){a=a.getBytes(l);l=String.fromCharCode.apply(null,a);if(f.onservercopy&&f.onservercopy(l))break;xa(l)||v.copyToClip("text/plain;"+l)}break;case 48:l=a.getString16LE(0,a.getEnd());ha(l);a.skip(a.getEnd()-a.getPosition());break;default:svGlobal.logger.warn("XX PDU:"+l)}}function U(a,c){O=a;P=c;p.width=a;p.height=c;w.resize(a,c);v&&
v.setSize(a,c);if(f.onresolutionchange)f.onresolutionchange(a,c)}function za(a){if(R&&(a=a.getData("text/plain"))){var c=a.length,d=new Int8Array(8+c);d[0]=6;d[4]=c>>24&255;d[5]=c>>16&255;d[6]=c>>8&255;d[7]=c&255;for(var b=0;b<c;b++)d[8+b]=a.charCodeAt(b);n.send(d.buffer)}}function ga(){loggedin=z=!1;N=new ma;S=new la}function ca(a,c,d,b){R&&(na=a,(a?1<<c:0)!=r[1]||d!=(r[2]<<8|r[3])||b!=(r[4]<<8|r[5]))&&(r[1]=a?1<<c:0,r[2]=d>>8&255,r[3]=d&255,r[4]=b>>8&255,r[5]=b&255,n.send(r.buffer))}function da(a,
c){M[1]=a?1:0;M[4]=c>>24&255;M[5]=c>>16&255;M[6]=c>>8&255;M[7]=c&255;n.send(M.buffer)}function oa(a,c){var d=Aa[c.toLowerCase()];d?f.writeScancode(a,d):(d=c.length,0!=d&&(1==d?f.writeKeyCode(a,c.toUpperCase().charCodeAt(0)):a&&f.writeText(c)))}sessionStorage&&sessionStorage.clear();this.displayMsg=!0;this.reconnectTimes=0;this.setTitle=this.openLink=!0;this.mode=0;var Y="object"==typeof g?g:null,pa="object"==typeof g||0<g.indexOf("/PLAY?");pa?(this.mode=1,Y&&(g=""),g+="&touchpad=on"):0<g.indexOf("/JOIN?")&&
(this.mode=2,this.reconnectOnResize=!1);var p=hi5.tool.queryToObj(g.substring(g.indexOf("?")+1));!p.width&&q&&(p.width=q,g+="&width="+q);!p.wHeight&&H&&(p.height=H,g+="&height="+H);!p.color&&X&&(p.color=X,g+="&color="+X);p.color||(p.color=32);this.server=p.server;this.port=parseInt(p.port,10);this.sessionInfo={major:0,minor:0,width:0,height:0,bpp:0,bigEndian:!0,trueColor:!0};var v=null,z=!1,R=!1,K=null;window.$vnc=this;var B=new fa(4194304);this.running=function(){return z};var f=this,n=null,L=4,
O=1024,P=768,T=[-16777216,-16777180,-16777143,-16777107,-16777070,-16777034,-16776997,-16776961,-16768E3,-16767964,-16767927,-16767891,-16767854,-16767818,-16767781,-16767745,-16758528,-16758492,-16758455,-16758419,-16758382,-16758346,-16758309,-16758273,-16749312,-16749276,-16749239,-16749203,-16749166,-16749130,-16749093,-16749057,-16739840,-16739804,-16739767,-16739731,-16739694,-16739658,-16739621,-16739585,-16730624,-16730588,-16730551,-16730515,-16730478,-16730442,-16730405,-16730369,-16721152,
-16721116,-16721079,-16721043,-16721006,-16720970,-16720933,-16720897,-16711936,-16711900,-16711863,-16711827,-16711790,-16711754,-16711717,-16711681,-11206656,-11206620,-11206583,-11206547,-11206510,-11206474,-11206437,-11206401,-11197440,-11197404,-11197367,-11197331,-11197294,-11197258,-11197221,-11197185,-11187968,-11187932,-11187895,-11187859,-11187822,-11187786,-11187749,-11187713,-11178752,-11178716,-11178679,-11178643,-11178606,-11178570,-11178533,-11178497,-11169280,-11169244,-11169207,-11169171,
-11169134,-11169098,-11169061,-11169025,-11160064,-11160028,-11159991,-11159955,-11159918,-11159882,-11159845,-11159809,-11150592,-11150556,-11150519,-11150483,-11150446,-11150410,-11150373,-11150337,-11141376,-11141340,-11141303,-11141267,-11141230,-11141194,-11141157,-11141121,-5636096,-5636060,-5636023,-5635987,-5635950,-5635914,-5635877,-5635841,-5626880,-5626844,-5626807,-5626771,-5626734,-5626698,-5626661,-5626625,-5617408,-5617372,-5617335,-5617299,-5617262,-5617226,-5617189,-5617153,-5608192,
-5608156,-5608119,-5608083,-5608046,-5608010,-5607973,-5607937,-5598720,-5598684,-5598647,-5598611,-5598574,-5598538,-5598501,-5598465,-5589504,-5589468,-5589431,-5589395,-5589358,-5589322,-5589285,-5589249,-5580032,-5579996,-5579959,-5579923,-5579886,-5579850,-5579813,-5579777,-5570816,-5570780,-5570743,-5570707,-5570670,-5570634,-5570597,-5570561,-65536,-65500,-65463,-65427,-65390,-65354,-65317,-65281,-56320,-56284,-56247,-56211,-56174,-56138,-56101,-56065,-46848,-46812,-46775,-46739,-46702,-46666,
-46629,-46593,-37632,-37596,-37559,-37523,-37486,-37450,-37413,-37377,-28160,-28124,-28087,-28051,-28014,-27978,-27941,-27905,-18944,-18908,-18871,-18835,-18798,-18762,-18725,-18689,-9472,-9436,-9399,-9363,-9326,-9290,-9253,-9217,-256,-220,-183,-147,-110,-74,-37,-1],w;w?w.resize(1024,768):w=new qa(1024,768);var I=w.getContext();this.writeKeyComb=function(a){a=a.split("+");var c=a.length;if(0!=c){for(var d=null,b=0;b<c;b++){var e=a[b];""==e&&""==d&&(e="Add");""!=e&&oa(!0,e);d=e}for(b=c-1;0<=b;b--)e=
a[b],""==e&&""==d&&(e="Add"),""!=e&&oa(!1,e),d=e}};var Z=new ta;hi5.appcfg&&(q=hi5.appcfg,H="undefined",typeof q.displayMsg!=H&&(this.displayMsg=q.displayMsg),typeof q.reconnectTimes!=H&&(this.reconnectTimes=q.reconnectTimes),typeof q.openLink!=H&&(this.openLink=q.openLink),typeof q.setTitle!=H&&(this.setTitle=q.setTitle),"boolean"==typeof q.useWSS&&(g=(hi5.appcfg.useWSS?"wss":"ws")+g.substring(g.indexOf("://"))));this.getURL=function(){return g};var Ba=parseInt(p.server_bpp||p.color||24);this.getColor=
function(){return Ba};this.setJoinMode=function(a){z&&n.send("8E1"+a)};this.refuseControl=function(a){z&&n.send("8E3"+a)};this.giveControl=function(a){z&&n.send("8E4"+a)};this.requestControl=function(){z&&n.send("8E2")};this.allowJoin=function(a,c){z&&n.send("8EA"+a+"\t"+(c?1:0))};this.play=function(){n.send("F3")};this.pause=function(){n.send("F2")};this.scan=function(a){n.send("F4"+(a?"1":"0"))};this.seek=function(a){v&&z&&(n.send("F4"+(a?"1":"0")+"\t"+(a/v.getScale()|0)),w.pause(!0))};this.run=
function(){ua()};this.hide=function(){v&&v.hide()};this.showMessage=function(a){f.displayMsg&&a&&hi5.notifications.notify({msg:a})};this.close=function(){if(n&&z)try{n.send("85"),n.close()}catch(a){V()}else V()};hi5.browser.isChromeApp?chrome.runtime.onSuspend.addListener(V):window.addEventListener("unload",V,!1);q=new Q(12,function(a){var c=82==a.getByte()&&70==a.getByte()&&66==a.getByte();if(c){a.skip(1);f.sessionInfo.major=100*(a.getByte()-48)+10*(a.getByte()-48)+(a.getByte()-48);a.skip(1);f.sessionInfo.minor=
100*(a.getByte()-48)+10*(a.getByte()-48)+(a.getByte()-48);svGlobal.logger.info("RFB major: "+f.sessionInfo.major+" minor: "+f.sessionInfo.minor);a.skip(1);a="RFB 003.003\n";for(var c=new Uint8Array(12),d=0;12>d;d++)c[d]=a.charCodeAt(d);n.send(c.buffer);B.setHandler(new Q(4,function(a){var c=a.getBE32();svGlobal.logger.info("sec type:"+c);switch(c){case 1:ja();break;case 2:B.setHandler(new Q(12,function(){svGlobal.logger.info("vnc auth");var c=new Int8Array(16);a.copyToByteArray(c,0,a.getPosition(),
16);a.skip(16);var d=p.pwd||"";8<d.length&&(d=d.substring(0,8));for(var e=[0,0,0,0,0,0,0,0],f=0,g=d.length;f<g;f++)e[f]=d.charCodeAt(f);d=new DesCipher(e);d.encrypt(c,0,c,0);d.encrypt(c,8,c,8);n.send(c.buffer);B.setHandler(new Q(4,ia))}));break;default:f.showMessage(__svi18n.vnc.securityError),f.close()}}))}else f.showMessage(__svi18n.vnc.notvnc),f.close()});B.setHandler(q);this.refresh=function(){ba(0,0,O,P,!1)};var aa=new Q(1,ya);2!=f.mode&&1!=f.mode||B.setHandler(aa);var N=new ma,S=new la;this.addSurface=
function(a){v=a;pa&&a.setPlayerMode();w.setContext(v.context);I=w.getContext();a.setAutoScale(0<f.mode);a.setSize(O,P);a.setController(Z);a.setFastCopy(W(p.fastCopy));a.setTouchpad(W(p.touchpad));a.setClipboard(W(p.mapClipboard));a.run(99997);a.onclipdata=za};var r=new Uint8Array(6);r[0]=5;var na=!1;this.mouseDown=function(a,c,d){ca(!0,d,a,c)};this.mouseMove=function(a,c){ca(na,0,a,c)};this.mouseUp=function(a,c,d){ca(!1,d,a,c)};this.writeKeyCode=function(a,c){f.writeRawInput("8B"+(a?0:49152)+"\t"+
c)};this.writeScancode=function(a,c){z&&("number"==typeof a?(f.writeRawInput("840\t"+a),f.writeRawInput("8449152\t"+a)):f.writeRawInput("84"+(a?0:49152)+"\t"+c))};this.writeText=function(a){f.writeRawInput("86"+a)};var Ca={57:32,201:65365,209:65366,207:65367,199:65360,203:65361,200:65362,205:65363,208:65364,183:65377,210:65379,211:65535,184:65514,219:65511,220:65512,1:65307,14:65288,15:65289,28:65293,29:65511,29:65507,42:65505,56:65513,59:65470,60:65471,61:65472,62:65473,63:65474,64:65475,65:65476,
66:65477,67:65478,68:65479,87:65480,88:65481,70:65300},M=new Uint8Array(8);M[0]=4;this.writeRawInput=function(a){if(R){var c=parseInt(a.substring(0,2),16);a=a.substring(2).split("\t");var d=0,b=!1;switch(c){case 128:f.mouseDown(parseInt(a[0]),parseInt(a[1]),parseInt(a[2]));return;case 129:f.mouseUp(parseInt(a[0]),parseInt(a[1]),parseInt(a[2]));return;case 130:f.mouseMove(parseInt(a[0]),parseInt(a[1]));return;case 131:d=0!=parseInt(a[2]);c=parseInt(a[0]);a=parseInt(a[1]);R&&(r[1]=d?16:8,r[2]=c>>8&
255,r[3]=c&255,r[4]=a>>8&255,r[5]=a&255,n.send(r.buffer),r[1]=2,n.send(r.buffer));return;case 132:d=Ca[a[1]]||0;b=0==a[0];break;case 139:d=String.fromCharCode(parseInt(a[1])).toLowerCase().charCodeAt(0);b=0==a[0];break;case 134:c=0;for(b=a[0].length;c<b;c++)d=a[0].charCodeAt(c),da(!0,d),da(!1,d);return}0<d?da(b,d):svGlobal.logger.info("Unknowncode: "+a[1]+" type:"+c)}};var Aa={" ":57,space:57,pageup:201,pagedown:209,end:207,home:199,left:203,up:200,right:205,down:208,printscreen:183,insert:210,del:211,
"delete":211,altgr:184,windows:219,windowsright:220,context:221,esc:1,backspace:14,tab:15,enter:28,meta:29,command:29,ctrl:29,shift:42,alt:56,capslock:58,f1:59,f2:60,f3:61,f4:62,f5:63,f6:64,f7:65,f8:66,f9:67,f10:68,f11:87,f12:88,numlock:69,scrolllock:70,add:78}};
