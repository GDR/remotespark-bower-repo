svGlobal.Player=function(){function B(){d=h=f=0;n=c=null;l=!1;b.state=b.CLOSED;d=h=f=0;n=c=null;l=!1}function u(b,a){return(b[a]&255)<<24|(b[a+1]&255)<<16|(b[a+2]&255)<<8|b[a+3]&255}function E(){h+=v;b.onprogress(h,f)}function F(t,a){if(b.state!=b.PLAYING)d-=8;else{var c=t.target.result,k=function(){w&&(clearInterval(w),w=0);if(b.onprogress)b.onprogress(a,f);h=a;if(b.state==b.PLAYING){if("RDPV"!=p)b.onmessage({data:c.slice(2)});else b.onmessage({data:c});d+=c.byteLength;q(8,x)}else d-=8};if(b.state==
b.PLAYING){var g=l?0:a-h;10>g&&(g=0);l&&0<m&&a>=m&&(b.onmessage({data:'3D{"type":2,"status":1}'}),l=!1,m=0);0<g?n=setTimeout(k,g):k();g>3*v&&(w=setInterval(E,v))}}}function x(c){if(b.state==b.PLAYING){var a=new Int8Array(c.target.result);if(8!=a.length){if(b.onprogress)b.onprogress(f,f);b.close()}else{c=u(a,0);var e=u(a,4);1>e&&(console.error("Duration:"+e),e=1);a=function(a){C=e;F(a,e)};b.state==b.PLAYING&&(d+=8,q(c,a))}}}function D(t){var a=new Int8Array(t.target.result);p=String.fromCharCode(a[0],
a[1],a[2],a[3]);t=(a[4]&255)<<8|a[5]&255;var e=(a[6]&255)<<8|a[7]&255,k=(a[8]&255)<<8|a[9]&255,g=a[10]&255;h=0;f=u(a,19)<<32|u(a,23);console.log("total time:"+f);v=f/100|0;if("RDPV"==p)(a=svManager.getInstance())&&a.close(),c=new svGlobal.Rdp(b,e,k,g),c.displayMsg=!1,a=new svGlobal.LocalInterface,a.setReadOnly(!0),a.hideWhenClose=!1,c.addSurface(a),c.run();else if("VNCV"==p)(a=svManager.getInstance())&&a.close(),c=new svGlobal.Vnc(b,e,k,g),c.displayMsg=!1,a=new svGlobal.LocalInterface,a.setReadOnly(!0),
a.hideWhenClose=!1,c.addSurface(a),c.run();else if("SSHV"==p)(a=svManager.getInstance())&&a.close(),c=new svGlobal.SSH(b,e,k,g),c.displayMsg=!1,a=new svGlobal.LocalInterface,a.setReadOnly(!0),a.hideWhenClose=!1,c.addSurface(a),c.run();else if("TELV"==p)(a=svManager.getInstance())&&a.close(),c=new svGlobal.TELNET(b,e,k,g),c.displayMsg=!1,a=new svGlobal.LocalInterface,a.setReadOnly(!0),a.hideWhenClose=!1,c.addSurface(a),c.run();else{hi5.notifications.notify("Invalid format!");return}if(b.onopen)b.onopen();
if(b.onopened)b.onopened({width:e,height:k,color:g,version:t,length:f,size:y.size});d=64;0<m&&c.getDesktop().pause(!0);q(8,x)}function q(c,a){if(b.state!=b.PLAYING){if(8==c)return;d-=8}var e=null;z?(e=y.slice(d,d+c),r=new FileReader,r.onload=a,r.readAsArrayBuffer(e)):(d=0,z=!0,q(64,D))}var b=this,d=0,h=0,f=0,v=0,w=0,y=null,n=null,c=null,r=null,l=!1,A=!1,m=0,p="";this.PLAYING=0;this.PAUSED=1;this.CLOSED=3;var C=0;this.state=this.CLOSED;var z=!0;this.close=function(){console.log("Player closed");try{b.onclose&&
(b.onclose({code:0,reason:""}),b.onclose=null),c&&(c.close(),c=null)}finally{B()}};this.setSource=function(c){if(r){try{r.abort()}catch(a){}r=null}b.state==b.PLAYING?(b.state=b.CLOSED,A=!0,n&&(clearTimeout(n),n=null),b.close()):(B(),A=!1);if(c){if(!("slice"in c||(c.slice=c.webkitSlice||c.mozSlice,"slice"in c))){alert(__svi18n.file.slice);return}y=c}else alert(__svi18n.player.noinput)};this.send=function(){};this.play=function(){b.state=b.PLAYING;if(0==d){var c=function(){d=0;q(64,D)};A?setTimeout(c,
888):c()}else q(8,x)};this.scan=function(b){l=b};this.pause=function(){b.state=b.PAUSED};this.seek=function(b){c&&(l=!0,c.getDesktop().pause(!0),m=parseInt(f*b/100),console.log("call for player"+b+"==="+m),m<C&&(z=!1))}};svGlobal.RdpPlayer=svGlobal.Player;
