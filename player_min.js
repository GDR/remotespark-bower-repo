svGlobal.Player=function(){function D(){h=m=l=0;p=c=null;g=false;a.state=a.CLOSED;h=m=l=0;p=c=null;g=false}function G(){if(q){try{q.abort()}catch(f){}q=null}if(a.state==a.PLAYING){a.state=a.CLOSED;x=true;if(p){clearTimeout(p);p=null}a.close()}else{D();x=false}}function y(a,b){return(a[b]&255)<<8|a[b+1]&255}function u(a,b){return(a[b]&255)<<24|(a[b+1]&255)<<16|(a[b+2]&255)<<8|a[b+3]&255}function H(){m+=v;a.onprogress(m,l)}function I(f,b){if(a.state!=a.PLAYING){h-=8;return}var k=f.target.result;var d=
function(){if(w){clearInterval(w);w=0}if(a.onprogress)a.onprogress(b,l);m=b;if(a.state==a.PLAYING){h+=k.byteLength;if(z)a.onmessage({"data":k.slice(2)});else a.onmessage({"data":k});r(8,A)}else h-=8};if(a.state==a.PLAYING){var e=g?0:b-m;if(e<10||m==0)e=0;if(g)if(n>0)if(b>=n){c.getDesktop().pause(false);g=false;n=0}if(e>0)p=setTimeout(d,e);else d();if(e>v*3)w=setInterval(H,v)}}function A(f){if(a.state!=a.PLAYING)return;var b=new Int8Array(f.target.result);if(b.length!=8){if(a.onprogress)a.onprogress(l,
l);a.close();return}var c=u(b,0);var d=u(b,4);if(d<0){console.error("Duration:"+d);d=0}var e=function(a){E=d;I(a,d)};if(a.state==a.PLAYING){h+=8;r(c,e)}}function J(f,b,k){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.Rdp(a,f,b,k);c.displayMsg=false;var e=new svGlobal.LocalInterface;e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}function K(f,b,k){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.Vnc(a,f,b,k);c.displayMsg=false;var e=new svGlobal.LocalInterface;
e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}function L(f,b,k){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.SSH(a,f,b,k);c.displayMsg=false;var e=new svGlobal.LocalInterface;e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}function M(f,b,k){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.TELNET(a,f,b,k);c.displayMsg=false;var e=new svGlobal.LocalInterface;e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}
function F(f){var b=new Int8Array(f.target.result);t=String.fromCharCode(b[0],b[1],b[2],b[3]);var k=y(b,4);var d=y(b,6);var e=y(b,8);var g=b[10]&255;m=0;l=u(b,19)<<32|u(b,23);console.log("total time:"+l+" type:"+t+" width:"+d+" height:"+e+" color:"+g);if(!d||!e){hi5.notifications.notify("Invalid resolution, width:"+d+" height:"+e);return}v=l/100|0;if(t=="RDPV")J(d,e,g);else if(t=="VNCV")K(d,e,g);else if(t=="SSHV"){z=true;L(d,e,g)}else if(t=="TELV"){z=true;M(d,e,g)}else{hi5.notifications.notify("Invalid format!");
return}if(a.onopen)a.onopen();if(a.onopened)a.onopened({"width":d,"height":e,"color":g,"version":k,"length":l,"size":B.size});h=64;if(n>0)c.getDesktop().pause(true);r(8,A)}function r(f,b){if(a.state!=a.PLAYING)if(f==8)return;else h-=8;var c=null;if(C)c=B.slice(h,h+f);else{h=0;C=true;r(64,F);return}q=new FileReader;q.onload=b;q.readAsArrayBuffer(c)}var a=this;var h=0;var m=0;var l=0;var v=0;var w=0;var B=null;var p=null;var c=null;var q=null;var g=false;var x=false;var n=0;var t="";var z=false;this.PLAYING=
0;this.PAUSED=1;this.CLOSED=3;var E=0;this.state=this.CLOSED;var C=true;this.close=function(){console.log("Player closed");try{if(a.onclose){a.onclose({"code":0,"reason":""});a.onclose=null}if(c){c.close();c=null}}finally{D()}};this.setSource=function(a){G();if(!a){alert(__svi18n.player.noinput);return}if(!("slice"in a)){a.slice=a.webkitSlice||a.mozSlice;if(!("slice"in a)){alert(__svi18n.file.slice);return}}B=a};this.send=function(){};this.play=function(){a.state=a.PLAYING;if(h==0){var c=function(){h=
0;r(64,F)};if(x)setTimeout(c,888);else c()}else r(8,A)};this.scan=function(a){g=a};this.pause=function(){a.state=a.PAUSED};this.seek=function(a){if(c){g=true;c.getDesktop().pause(true);n=parseInt(l*a/100);console.log("call for player"+a+"==="+n);if(n<E)C=false}}};svGlobal.RdpPlayer=svGlobal.Player;
