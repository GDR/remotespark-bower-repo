svGlobal.Player=function(){function D(){d=k=f=0;q=c=null;e=!1;b.state=b.CLOSED;d=k=f=0;q=c=null;e=!1}function w(b,a){return(b[a]&255)<<24|(b[a+1]&255)<<16|(b[a+2]&255)<<8|b[a+3]&255}function G(){k+=x;b.onprogress(k,f)}function H(v,a){if(b.state!=b.PLAYING)d-=8;else{var c=v.target.result,l=function(){y&&(clearInterval(y),y=0);if(b.onprogress)b.onprogress(a,f);k=a;if(b.state==b.PLAYING){if("RDPV"!=r)b.onmessage({data:c.slice(2)});else b.onmessage({data:c});d+=c.byteLength;t(8,z)}else d-=8};if(b.state==
b.PLAYING){var h=e?0:a-k;10>h&&(h=0);e&&0<n&&a>=n&&(b.onmessage({data:'3D{"type":2,"status":1}'}),e=!1,n=0);0<h?q=setTimeout(l,h):l();h>3*x&&(y=setInterval(G,x))}}}function z(c){if(b.state==b.PLAYING){var a=new Int8Array(c.target.result);if(8!=a.length){if(b.onprogress)b.onprogress(f,f);b.close()}else{c=w(a,0);var g=w(a,4);1>g&&(console.error("Duration:"+g),g=1);a=function(a){E=g;H(a,g)};b.state==b.PLAYING&&(d+=8,t(c,a))}}}function F(v){var a=new Int8Array(v.target.result);r=String.fromCharCode(a[0],
a[1],a[2],a[3]);v=(a[4]&255)<<8|a[5]&255;var g=(a[6]&255)<<8|a[7]&255,l=(a[8]&255)<<8|a[9]&255,h=a[10]&255;k=0;f=w(a,19)<<32|w(a,23);console.log("total time:"+f);x=f/100|0;if("RDPV"==r){var a=g,e=l,p=h,m=svManager.getInstance();m&&m.close();c=new svGlobal.Rdp(b,a,e,p);c.displayMsg=!1;a=new svGlobal.LocalInterface;a.setReadOnly(!0);a.hideWhenClose=!1;c.addSurface(a);c.run()}else if("VNCV"==r)a=g,e=l,p=h,(m=svManager.getInstance())&&m.close(),c=new svGlobal.Vnc(b,a,e,p),c.displayMsg=!1,a=new svGlobal.LocalInterface,
a.setReadOnly(!0),a.hideWhenClose=!1,c.addSurface(a),c.run();else if("SSHV"==r)a=g,e=l,p=h,(m=svManager.getInstance())&&m.close(),c=new svGlobal.SSH(b,a,e,p),c.displayMsg=!1,a=new svGlobal.LocalInterface,a.setReadOnly(!0),a.hideWhenClose=!1,c.addSurface(a),c.run();else if("TELV"==r)a=g,e=l,p=h,(m=svManager.getInstance())&&m.close(),c=new svGlobal.TELNET(b,a,e,p),c.displayMsg=!1,a=new svGlobal.LocalInterface,a.setReadOnly(!0),a.hideWhenClose=!1,c.addSurface(a),c.run();else{hi5.notifications.notify("Invalid format!");
return}if(b.onopen)b.onopen();if(b.onopened)b.onopened({width:g,height:l,color:h,version:v,length:f,size:A.size});d=64;0<n&&c.getDesktop().pause(!0);t(8,z)}function t(c,a){if(b.state!=b.PLAYING){if(8==c)return;d-=8}var e=null;B?(e=A.slice(d,d+c),u=new FileReader,u.onload=a,u.readAsArrayBuffer(e)):(d=0,B=!0,t(64,F))}var b=this,d=0,k=0,f=0,x=0,y=0,A=null,q=null,c=null,u=null,e=!1,C=!1,n=0,r="";this.PLAYING=0;this.PAUSED=1;this.CLOSED=3;var E=0;this.state=this.CLOSED;var B=!0;this.close=function(){console.log("Player closed");
try{b.onclose&&(b.onclose({code:0,reason:""}),b.onclose=null),c&&(c.close(),c=null)}finally{D()}};this.setSource=function(c){if(u){try{u.abort()}catch(a){}u=null}b.state==b.PLAYING?(b.state=b.CLOSED,C=!0,q&&(clearTimeout(q),q=null),b.close()):(D(),C=!1);if(c){if(!("slice"in c||(c.slice=c.webkitSlice||c.mozSlice,"slice"in c))){alert(__svi18n.file.slice);return}A=c}else alert(__svi18n.player.noinput)};this.send=function(){};this.play=function(){b.state=b.PLAYING;if(0==d){var c=function(){d=0;t(64,F)};
C?setTimeout(c,888):c()}else t(8,z)};this.scan=function(b){e=b};this.pause=function(){b.state=b.PAUSED};this.seek=function(b){c&&(e=!0,c.getDesktop().pause(!0),n=parseInt(f*b/100),console.log("call for player"+b+"==="+n),n<E&&(B=!1))}};svGlobal.RdpPlayer=svGlobal.Player;
